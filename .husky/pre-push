echo "ðŸ” Running pre-push checks..."
echo ""

# Colors for output (if terminal supports it)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored messages
print_error() {
    echo "${RED}âŒ $1${NC}"
}

print_success() {
    echo "${GREEN}âœ… $1${NC}"
}

print_info() {
    echo "${BLUE}â„¹ï¸  $1${NC}"
}

print_warning() {
    echo "${YELLOW}âš ï¸  $1${NC}"
}

# Check if npm is available
if ! command -v npm >/dev/null 2>&1; then
    print_error "npm is not available. Please install Node.js and npm."
    exit 1
fi

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    print_error "Not in a git repository!"
    exit 1
fi

# Get the remote branch name
REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null)
if [ -z "$REMOTE_BRANCH" ]; then
    print_warning "No upstream branch set. Skipping pre-push checks."
    exit 0
fi

# Check if there are commits to push
LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse @{u} 2>/dev/null)
BASE=$(git merge-base @ @{u} 2>/dev/null)

if [ "$LOCAL" = "$REMOTE" ]; then
    print_info "No commits to push. Skipping checks."
    exit 0
fi

# Track if any check fails
FAILED=0
START_TIME=$(date +%s)

# Run TypeScript type check with output capture
echo "ðŸ“ Type checking TypeScript files..."
TYPE_CHECK_OUTPUT=$(npm run -s type-check:all 2>&1)
TYPE_CHECK_EXIT=$?

if [ $TYPE_CHECK_EXIT -eq 0 ]; then
    print_success "TypeScript type check passed"
else
    print_error "TypeScript type check failed!"
    echo ""
    # Show first 10 errors
    echo "$TYPE_CHECK_OUTPUT" | grep -E "error TS" | head -10
    if [ $(echo "$TYPE_CHECK_OUTPUT" | grep -E "error TS" | wc -l) -gt 10 ]; then
        echo "... (and more errors)"
    fi
    echo ""
    echo "ðŸ’¡ Run 'npm run type-check:all' to see all errors."
    FAILED=1
fi
echo ""

# Run linters with output capture
echo "ðŸ§¹ Running linters..."
LINT_OUTPUT=$(npm run -s lint:all 2>&1)
LINT_EXIT=$?

if [ $LINT_EXIT -eq 0 ]; then
    print_success "Linting passed"
else
    print_error "Linting failed!"
    echo ""
    # Show first 10 linting errors
    echo "$LINT_OUTPUT" | grep -E "(error|warning)" | head -10
    if [ $(echo "$LINT_OUTPUT" | grep -E "(error|warning)" | wc -l) -gt 10 ]; then
        echo "... (and more errors)"
    fi
    echo ""
    echo "ðŸ’¡ Run 'npm run lint:all' to see all errors."
    echo "ðŸ’¡ Or run 'npm run lint:all:fix' to auto-fix issues."
    FAILED=1
fi
echo ""

# Validate Blade templates
# Set SKIP_BLADE_CHECK=1 to skip Blade template validation during pre-push
if [ -z "$SKIP_BLADE_CHECK" ] && command -v php >/dev/null 2>&1; then
    echo "ðŸ” Validating Blade templates..."
    # Clear view cache first, then try to cache (which validates syntax)
    BLADE_VALIDATION_OUTPUT=$(php artisan view:clear 2>&1 && php artisan view:cache 2>&1)
    BLADE_VALIDATION_EXIT=$?
    
    if [ $BLADE_VALIDATION_EXIT -eq 0 ]; then
        print_success "Blade templates validated"
        # Clear cache again to avoid leaving cached views
        php artisan view:clear >/dev/null 2>&1
    else
        print_error "Blade template validation failed!"
        echo ""
        # Show validation errors
        echo "$BLADE_VALIDATION_OUTPUT" | grep -E "(error|Error|Exception|syntax)" | head -20
        if [ $(echo "$BLADE_VALIDATION_OUTPUT" | grep -E "(error|Error|Exception|syntax)" | wc -l) -gt 20 ]; then
            echo "... (and more errors)"
        fi
        echo ""
        echo "ðŸ’¡ Run 'php artisan view:cache' to see full validation errors."
        echo "ðŸ’¡ Or set SKIP_BLADE_CHECK=1 to skip Blade template validation during pre-push."
        FAILED=1
    fi
    echo ""
elif [ -n "$SKIP_BLADE_CHECK" ]; then
    print_info "Skipping Blade template validation (SKIP_BLADE_CHECK is set)"
    echo ""
elif ! command -v php >/dev/null 2>&1; then
    print_warning "PHP not found. Skipping Blade template validation."
    echo ""
fi

# Run frontend tests (Vitest)
# Set SKIP_FRONTEND_TESTS=1 to skip frontend tests during pre-push
if [ -z "$SKIP_FRONTEND_TESTS" ]; then
    echo "ðŸ§ª Running frontend tests..."
    FRONTEND_TEST_OUTPUT=$(npm run -s test:frontend 2>&1)
    FRONTEND_TEST_EXIT=$?
    
    if [ $FRONTEND_TEST_EXIT -eq 0 ]; then
        print_success "Frontend tests passed"
        # Show test summary (last 20 lines which usually contain the summary)
        echo "$FRONTEND_TEST_OUTPUT" | tail -20
    else
        print_error "Frontend tests failed!"
        echo ""
        # Show test output (last 40 lines for context)
        echo "$FRONTEND_TEST_OUTPUT" | tail -40
        echo ""
        echo "ðŸ’¡ Run 'npm run test:frontend' to see full test results."
        echo "ðŸ’¡ Or set SKIP_FRONTEND_TESTS=1 to skip frontend tests during pre-push."
        FAILED=1
    fi
    echo ""
elif [ -n "$SKIP_FRONTEND_TESTS" ]; then
    print_info "Skipping frontend tests (SKIP_FRONTEND_TESTS is set)"
    echo ""
fi

# Optional: Run PHP tests
# Set SKIP_PHP_TESTS=1 to skip PHP tests during pre-push
if [ -z "$SKIP_PHP_TESTS" ] && [ -f "./vendor/bin/phpunit" ]; then
    echo "ðŸ§ª Running PHP tests..."
    # Use --testdox for better output, but limit to last 30 lines to keep it concise
    PHP_TEST_OUTPUT=$(./vendor/bin/phpunit --testdox 2>&1)
    PHP_TEST_EXIT=$?
    
    if [ $PHP_TEST_EXIT -eq 0 ]; then
        print_success "PHP tests passed"
        # Show test summary (last 15 lines which usually contain the summary)
        echo "$PHP_TEST_OUTPUT" | tail -15
    else
        print_error "PHP tests failed!"
        echo ""
        # Show test output (last 30 lines for context)
        echo "$PHP_TEST_OUTPUT" | tail -30
        echo ""
        echo "ðŸ’¡ Run './vendor/bin/phpunit' to see full test results."
        echo "ðŸ’¡ Or set SKIP_PHP_TESTS=1 to skip PHP tests during pre-push."
        FAILED=1
    fi
    echo ""
elif [ -n "$SKIP_PHP_TESTS" ]; then
    print_info "Skipping PHP tests (SKIP_PHP_TESTS is set)"
    echo ""
elif [ ! -f "./vendor/bin/phpunit" ]; then
    print_warning "PHPUnit not found. Run 'composer install' to install dependencies."
    echo ""
fi

# Calculate duration
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

# Final result
if [ $FAILED -eq 1 ]; then
    echo ""
    print_error "Pre-push checks failed! (took ${DURATION}s)"
    echo ""
    echo "ðŸ’¡ Fix the errors above before pushing."
    echo "ðŸ’¡ Or use 'git push --no-verify' to skip (not recommended)."
    exit 1
fi

print_success "All pre-push checks passed! (took ${DURATION}s)"
exit 0
