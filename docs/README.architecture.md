# Architecture Overview (for AI and Humans)

This document gives a **high-level map** of the project so AI and new developers know where things live and how they fit together. For detailed decisions, see `docs/adr/`.

---

## Stack

- **Backend:** Laravel 12, PHP 8.4
- **Frontend:** TypeScript, Vite, Bootstrap 5 / Tailwind
- **Env:** Docker (Laradock). PHP/artisan/composer run inside `laradock-workspace`.

---

## Where Things Live

| Layer / Concern                  | Location                                                       | Notes                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -------------------------------- | -------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Routes**                       | `routes/`                                                      | `web.php` (requires `web/sitemap.php`, `web/files.php`, `web/dashboard.php`, `auth.php`); `api.php` (requires `api/releases.php`); `breadcrumbs.php`; `fallback.php` loaded last; optional `routes/cache/*.php`                                                                                                                                                                                                                 |
| **Route macro**                  | `AppServiceProvider::boot()`                                   | `Route::macro('localized', ...)` for optional Laravel Localization                                                                                                                                                                                                                                                                                                                                                              |
| **Breadcrumbs**                  | `routes/breadcrumbs.php`, `config/breadcrumbs.php`             | Diglactic Breadcrumbs; definitions in routes, config points to file                                                                                                                                                                                                                                                                                                                                                             |
| **Middleware**                   | `bootstrap/app.php`                                            | No `app/Http/Kernel.php` in Laravel 12; aliases: `theme`, `doNotCacheResponse`, `throttle.form`, Laravel Localization aliases                                                                                                                                                                                                                                                                                                   |
| **Rate limiters**                | `AppServiceProvider::configureRateLimiting()`                  | Named: `api`, `api:authenticated`, `form-submission`, `admin-api`, `password-reset`, `email-verification`, `web`                                                                                                                                                                                                                                                                                                                |
| **Controllers (app)**            | `app/Http/Controllers/`                                        | Extend `BaseController`; page vs API base classes differ; prefer **constructor injection** with **readonly** dependencies                                                                                                                                                                                                                                                                                                       |
| **Admin controllers**            | `app/Admin/Controllers/`                                       | Extend `AdminBaseController` / `AdminBaseApiController`                                                                                                                                                                                                                                                                                                                                                                         |
| **Repositories**                 | `app/Repositories/`                                            | Extend `BaseRepository` (Prettus); implement `model()`; DB access via repositories only                                                                                                                                                                                                                                                                                                                                         |
| **Repository traits**            | `app/Repositories/Traits/`                                     | `Reference`, `Status`, `ActiveTreeList` (nested-set); use when model has matching scopes                                                                                                                                                                                                                                                                                                                                        |
| **Services**                     | `app/Services/`                                                | Business logic; public services: interface in `Contracts/`, bound in AppServiceProvider                                                                                                                                                                                                                                                                                                                                         |
| **Internal services**            | `app/Services/`                                                | No interface: FormFieldFormatterService, NotificationSenderService, SitemapBuilderService; used only inside app                                                                                                                                                                                                                                                                                                                 |
| **Translation**                  | `AppServiceProvider` (singletons), `app/Services/Translation/` | TranslationRepository, TranslationService; drivers: TranslatorInterface, DeepSeekTranslator, OpenAITranslator                                                                                                                                                                                                                                                                                                                   |
| **Models**                       | `app/Models/`                                                  | Eloquent models; used by repositories, not directly in controllers. **Nested set:** extend `app/Models/NestedSetModel` (NodeTrait); Menu, ArticleCategory, ProductCategory; repository trait ActiveTreeList (getActiveList, getTree), NestedSetModel::formatTreeArray(). **Reference vs slug:** reference = unique human-readable identifier (admin/API), auto-generated via ScopeReference; slug = URL path (Sluggable trait). |
| **Model traits**                 | `app/Models/Traits/`                                           | ScopeStatus, ScopeReference, Sluggable, ClearsResponseCache, HasFilesOfType, HasMarkdownContent, HasMissingIds, HasMonetaryFields, LocalizesDateTime, ScopePublished, UnsetsUnderscoreAttributes; enum casts for status/type                                                                                                                                                                                                    |
| **Observers**                    | `app/Observers/`                                               | Side effects only (e.g. cache clear, event dispatch); register in `AppServiceProvider::boot()` with `Model::observe()`                                                                                                                                                                                                                                                                                                          |
| **Enums**                        | `app/Enums/`                                                   | Backed enums for status/type columns; use `label()`, `toArray()`; cast in model `$casts`                                                                                                                                                                                                                                                                                                                                        |
| **DTOs**                         | `app/DTOs/`                                                    | Spatie Laravel Data; type-safe transfer; see `app/DTOs/README.md`                                                                                                                                                                                                                                                                                                                                                               |
| **Exceptions**                   | `app/Exceptions/`                                              | Extend BaseException (→ BaseBusinessException, BaseNotFoundException); Handler.php here                                                                                                                                                                                                                                                                                                                                         |
| **API responses**                | `app/Traits/ApiResponseTrait`                                  | Used by BaseApiController; success(), error(), failValidation(), failAuth(), failForbidden(), failServer(), flattenJson(), throwBusinessError(). JSON: status, code, message, data/errors; no JsonResource/ApiResource                                                                                                                                                                                                          |
| **Service binding**              | `app/Providers/AppServiceProvider`                             | Public service interfaces → implementations; internal services have no interface                                                                                                                                                                                                                                                                                                                                                |
| **Actions**                      | `app/Actions/`                                                 | Fortify/Jetstream auth and team actions; subfolders Fortify/, Jetstream/                                                                                                                                                                                                                                                                                                                                                        |
| **Events**                       | `app/Events/`                                                  | Domain events (e.g. PageCreated); dispatched from Observers                                                                                                                                                                                                                                                                                                                                                                     |
| **Listeners**                    | `app/Listeners/`                                               | Handle events (e.g. ClearSitemapCache); some implement ShouldQueue                                                                                                                                                                                                                                                                                                                                                              |
| **Jobs**                         | `app/Jobs/`                                                    | Queued work                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Livewire**                     | `app/Livewire/`                                                | Livewire components for reactive UI; base block `GeneralBlock` ($viewName, $style, displayOptions, queryOptions, publish/expire); style-specific views: `component-name_style.blade.php`. Block rendering: `BlockRendererService`; theme `manifest.json` (templates); config `appsolutely.blocks` maps block class → repositories. See docs/block-system.md.                                                                    |
| **Console commands**             | `app/Console/Commands/`                                        | Artisan commands (e.g. sitemap, notifications, translate, forms:export)                                                                                                                                                                                                                                                                                                                                                         |
| **Helpers**                      | `app/Helpers/helpers.php`, `app/Helpers/`                      | Global: **t(), **tv(), log_error(), client_ip(), page_meta(), appsolutely(), themed_absolute_path(); helper classes (FileHelper, etc.)                                                                                                                                                                                                                                                                                          |
| **Blade directives**             | `AppServiceProvider::boot()`                                   | @t, @tv, @renderBlock, @title, @keywords, @description; page_meta($page, $key) in views                                                                                                                                                                                                                                                                                                                                         |
| **View Components**              | `app/View/Components/`                                         | e.g. AppLayout, GuestLayout                                                                                                                                                                                                                                                                                                                                                                                                     |
| **View namespaces**              | `AppServiceProvider::boot()`                                   | `page-builder` → resource_path('page-builder'); resources/page-builder/ for page builder views/assets                                                                                                                                                                                                                                                                                                                           |
| **i18n**                         | `lang/`                                                        | Locales en/, zh_CN/, zh_TW/; keys in admin.php, global.php, menu.php, extension.php; use **t(), **tv()                                                                                                                                                                                                                                                                                                                          |
| **Form Requests**                | `app/Http/Requests/`                                           | Validate HTTP input; no app/Rules/ — use inline rules or Form Requests                                                                                                                                                                                                                                                                                                                                                          |
| **Middleware**                   | `app/Http/Middleware/`                                         | CacheProfile (response cache; excludes Livewire, admin, auth), RestrictRoutePrefixes (feature toggles via config appsolutely.features.disabled), SecurityHeaders, SetThemeMiddleware, ThrottleFormSubmissions, TrustProxies; registered in bootstrap/app.php. Use doNotCacheResponse on routes that must never be cached.                                                                                                       |
| **Admin (Dcat)**                 | `app/Admin/`                                                   | Controllers/, Actions/Grid/, Extensions/Grid/, Forms/ (Models/_, Fields/_ e.g. Markdown, NestedSetForm, ProductSkuForm), Metrics/ (e.g. Examples/), bootstrap.php, routes.php                                                                                                                                                                                                                                                   |
| **App config**                   | `app/Config/`                                                  | PHP config classes (e.g. BasicConfig, MailConfig)                                                                                                                                                                                                                                                                                                                                                                               |
| **Constants**                    | `app/Constants/`                                               | e.g. BasicConstant                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Facades / Policies / Logging** | `app/Facades/`, `app/Policies/`, `app/Logging/`                | Custom facades; authorization via Policies (e.g. TeamPolicy) and Gate::forUser($user)->authorize(...) in Fortify/Jetstream actions; logging formatters                                                                                                                                                                                                                                                                          |
| **Providers**                    | `app/Providers/`                                               | AppServiceProvider, EventServiceProvider, ThemeServiceProvider, TranslationServiceProvider, FortifyServiceProvider, JetstreamServiceProvider                                                                                                                                                                                                                                                                                    |
| **Migrations**                   | `database/migrations/`                                         | Follow existing naming and structure                                                                                                                                                                                                                                                                                                                                                                                            |
| **Factories**                    | `database/factories/`                                          | Copy from existing; no artisan make                                                                                                                                                                                                                                                                                                                                                                                             |
| **Seeders**                      | `database/seeders/`                                            | Copy from existing; no artisan make                                                                                                                                                                                                                                                                                                                                                                                             |
| **Views / themes**               | `resources/views/`, `themes/`                                  | Theme system; see docs/theme-development-guide.md                                                                                                                                                                                                                                                                                                                                                                               |
| **Frontend (TS)**                | `resources/`, `themes.ts`, `vite.config.ts`                    | TypeScript conventions in docs/typescript-conventions.md                                                                                                                                                                                                                                                                                                                                                                        |
| **Config**                       | `config/`                                                      | Standard Laravel config; config/appsolutely.php (prefix, theme, storage, features.disabled, blocks, seo, security.csp)                                                                                                                                                                                                                                                                                                          |
| **Tests**                        | `tests/`                                                       | Feature/ (HTTP/feature), Integration/ (workflows), Unit/ by layer (Listeners/, Models/, Repositories/, Services/); frontend: tests/frontend/ (Vitest: components/, services/)                                                                                                                                                                                                                                                   |
| **ADRs**                         | `docs/adr/`                                                    | Architecture decision records                                                                                                                                                                                                                                                                                                                                                                                                   |

---

## Conventions (Summary)

- **Repository pattern** — All DB access via Repositories.
- **Service layer** — Business logic in Services; controllers stay thin. Public services have interfaces in `app/Services/Contracts/`; internal-only services (e.g. FormFieldFormatterService, NotificationSenderService, SitemapBuilderService) have no interface.
- **No artisan make:** — Do not use `make:model`, `make:controller`, `make:migration`; copy from existing code (including factories and seeders).
- **Controllers:** Final classes; prefer **constructor injection** with **readonly** dependencies; use method or service injection when needed.
- **Imports:** Alphabetical, no unused `use` statements.
- **DRY** — Extract repeated logic into functions/methods/helpers; reuse instead of duplicating.
- **Enums** — For new table columns with a fixed set of values (status, type, role), consider PHP enums in `app/Enums/`; backed enum with `label()`, `toArray()`; cast in model `$casts`.
- **Repository base** — Repositories extend `App\Repositories\BaseRepository` (Prettus); implement `model()`; reuse traits in `app/Repositories/Traits/` when the model has matching scopes.
- **Model traits** — Reuse `app/Models/Traits/` (ScopeStatus, ScopeReference, Sluggable, ClearsResponseCache, HasFilesOfType, HasMarkdownContent, HasMonetaryFields, LocalizesDateTime, ScopePublished, etc.). **Reference vs slug:** reference = unique identifier (admin/API), auto-generated via ScopeReference; slug = URL path (Sluggable). **Nested set:** models extend `app/Models/NestedSetModel` (NodeTrait); repository trait `ActiveTreeList` (getActiveList, getTree); `NestedSetModel::formatTreeArray()`.
- **Response cache** — Custom CacheProfile excludes Livewire, admin domain/prefix, authenticated users; use `doNotCacheResponse` on routes that must never be cached; ClearsResponseCache on models clears cache on change.
- **Route restriction** — RestrictRoutePrefixes + RouteRestrictionService; `config('appsolutely.features.disabled')` (comma-separated) = URL prefixes that return 404.
- **Observers** — Side effects only in `app/Observers/`; register in `AppServiceProvider::boot()` with `Model::observe()`.
- **DTOs** — Use Spatie Laravel Data in `app/DTOs/` for type-safe transfer and API responses; see `app/DTOs/README.md`.
- **Exceptions** — Custom exceptions extend `App\Exceptions\BaseException` (or `BaseBusinessException`, `BaseNotFoundException`, etc.); keep user-facing vs technical message convention.
- **API responses** — API controllers use `ApiResponseTrait` on `BaseApiController`; return JSON with `status`, `code`, `message`, and `data` or `errors`; business errors often HTTP 200 with `status: false`. No `JsonResource`/`ApiResource`; use arrays/DTOs.
- **Service binding** — New public services: add interface in `app/Services/Contracts/`, implementation in `app/Services/`, bind in `AppServiceProvider`. Translation: TranslationRepository and TranslationService registered as singletons; drivers in `app/Services/Translation/`.
- **Events & Listeners** — Observers dispatch events from `app/Events/`; listeners in `app/Listeners/` handle side effects; some listeners implement `ShouldQueue`. Jobs go in `app/Jobs/`. Actions (auth/team) live in `app/Actions/` (Fortify/Jetstream).
- **Livewire / Console** — Livewire components in `app/Livewire/`; Artisan commands in `app/Console/Commands/`.
- **Helpers / i18n** — Global helpers in `app/Helpers/helpers.php` (e.g. `__t()`, `__tv()`, `log_error()`, `client_ip()`, `page_meta()`); helper classes in `app/Helpers/`. Translations: `lang/` with locales; use `__t()`; update all language files when adding strings.
- **Blade directives** — Registered in AppServiceProvider: `@t`, `@tv`, `@renderBlock`, `@title`, `@keywords`, `@description`; use `page_meta($page, $key)` in views.
- **View Components / namespaces** — `app/View/Components/` (AppLayout, GuestLayout); view namespace `page-builder` → `resource_path('page-builder')`.
- **Form Requests** — Validate user input via Form Requests in `app/Http/Requests/`; do not trust raw request data in controllers. No custom `app/Rules/`; use inline rules or Form Requests.
- **Middleware** — Custom middleware in `app/Http/Middleware/`; register in `bootstrap/app.php`. Aliases: `theme`, `doNotCacheResponse`, `throttle.form`, Laravel Localization aliases.
- **Routes** — `web.php` requires `web/*.php`, `auth.php`; `api.php` requires `api/*.php`; `fallback.php` loaded last; optional `routes/cache/*.php`. Breadcrumbs in `routes/breadcrumbs.php`. `Route::macro('localized', ...)` for optional i18n.
- **Rate limiters** — Defined in `AppServiceProvider::configureRateLimiting()`: api, api:authenticated, form-submission, admin-api, password-reset, email-verification, web.
- **Admin** — Dcat Admin in `app/Admin/`: Controllers, Actions/Grid, Extensions/Grid, Forms (Models/_, Fields/_, NestedSetForm, ProductSkuForm), Metrics/, bootstrap, routes.
- **App config / Constants / Providers** — `app/Config/`, `app/Constants/`, `app/Facades/`, `app/Policies/`, `app/Logging/`; providers: AppServiceProvider, EventServiceProvider, ThemeServiceProvider, TranslationServiceProvider, FortifyServiceProvider, JetstreamServiceProvider.
- **Key packages** — `prettus/l5-repository` (BaseRepository), `spatie/laravel-data` (DTOs), `kalnoy/nestedset` (nested set), `dcat/laravel-admin` (Admin), `qirolab/laravel-themer` (themes), `spatie/laravel-responsecache` (response cache), Diglactic Breadcrumbs, Mcamara Laravel Localization.

---

## Additional Behaviour

- **404 handling** — In `bootstrap/app.php` `withExceptions`: JSON requests get JSON 404; web requests use theme resolution and themed `errors.404` when available.
- **Admin file upload route** — Admin files upload route is rebound in `AppServiceProvider::boot()` by matching URI to `Admin\Controllers\Api\FileController@upload`.
- **Response cache** — CacheProfile (`app/Http/Middleware/CacheProfile.php`) extends Spatie’s; excludes Livewire (X-Livewire), admin domain/prefix, authenticated users. Use `doNotCacheResponse` middleware on routes that must never be cached.
- **Route restriction** — RestrictRoutePrefixes middleware + RouteRestrictionService; `config('appsolutely.features.disabled')` (comma-separated list) = URL segment prefixes that return 404.

---

## Special Folders

- **`Tabler/`** — Cloned upstream; **do not modify**.
- **`Applise/`** — Internal Laravel package (templates, Artisan commands).

---

## Entry Points for AI

1. **AGENTS.md** (project root) — Agent entry point and non-negotiables.
2. **This file** — Where things live and how layers connect.
3. **`.cursor/rules/`** — Project and stack-specific rules (project.mdc, senior.mdc, laravel.mdc, front-end.mdc, project-rules/\*).
4. **`docs/adr/`** — Why we use repositories, services, strict types, etc.

Use this map to decide where to add or change code and which existing files to mirror.

---

## Documentation maintenance

- **All project docs live in `docs/`** (see AGENTS.md → Documentation).
- **When implementation/build/fixes are finished**, update any related docs under `docs/` so documentation stays up-to-date.
